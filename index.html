<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zmgame下载站2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#10b981',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .file-card {
                @apply bg-white rounded-lg shadow p-4 hover:shadow-md transition-shadow duration-300;
            }
            .btn-download {
                @apply bg-secondary text-white px-3 py-1 rounded text-sm hover:bg-secondary/90 transition-colors;
            }
            .btn-retry {
                @apply bg-primary text-white px-3 py-1 rounded text-sm hover:bg-primary/90 transition-colors;
            }
            .download-status {
                @apply text-sm mt-2 inline-block;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-primary text-white py-6">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl md:text-3xl font-bold flex items-center">
                <i class="fa fa-github mr-3"></i>zmgame工作室
            </h1>
            <p class="mt-2 opacity-90">新的更新形式！更方便！</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="mb-6 bg-white p-4 rounded-lg shadow">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800">
                        仓库: <span class="text-primary">km1753/zmgame</span>
                    </h2>
                    <p class="text-gray-600 text-sm mt-1">
                        <span id="file-count">0</span> 个文件 | 最后更新: <span id="last-update">加载中...</span>
                    </p>
                </div>
                <button id="refresh-btn" class="bg-primary text-white px-4 py-2 rounded flex items-center justify-center hover:bg-primary/90 transition-colors">
                    <i class="fa fa-refresh mr-2"></i>刷新文件列表
                </button>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loading" class="flex justify-center items-center py-16">
            <div class="text-center">
                <i class="fa fa-circle-o-notch fa-spin text-3xl text-primary mb-3"></i>
                <p>正在获取文件列表...</p>
            </div>
        </div>

        <!-- 错误状态 -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <i class="fa fa-exclamation-circle text-red-500 text-2xl mb-2"></i>
            <p>无法获取文件列表</p>
            <p class="text-sm text-gray-500 mt-2">可能是API请求限制或网络问题，请稍后重试</p>
            <button id="retry-btn" class="mt-3 btn-retry">
                <i class="fa fa-refresh mr-1"></i>重试
            </button>
        </div>

        <!-- 文件列表 -->
        <div id="file-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>数据来源于GitHub API，遵守<a href="https://docs.github.com/en/site-policy" class="text-blue-300 underline" target="_blank">GitHub服务条款</a></p>
            <p class="text-sm mt-2 text-gray-400">仅供学习交流使用，下载内容请遵守相关版权规定</p>
        </div>
    </footer>

    <script>
        // 配置信息
        const GITHUB_USER = 'km1753';
        const GITHUB_REPO = 'zmgame';
        const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents`;
        const RAW_GITHUB_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main`;
        const CACHE_DURATION = 10800000; // 3小时缓存 (毫秒)

        // DOM元素
        const fileListEl = document.getElementById('file-list');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const fileCountEl = document.getElementById('file-count');
        const lastUpdateEl = document.getElementById('last-update');
        const refreshBtn = document.getElementById('refresh-btn');
        const retryBtn = document.getElementById('retry-btn');

        // 页面加载时获取文件列表
        document.addEventListener('DOMContentLoaded', () => {
            fetchFileList();
            
            // 事件监听
            refreshBtn.addEventListener('click', () => fetchFileList(true));
            retryBtn.addEventListener('click', () => fetchFileList(true));
        });

        // 获取文件列表
        async function fetchFileList(forceRefresh = false) {
            showLoading();
            
            try {
                // 检查缓存
                const cachedData = localStorage.getItem('githubFileData');
                const cacheTime = localStorage.getItem('githubFileCacheTime');
                
                if (cachedData && cacheTime && !forceRefresh) {
                    const now = new Date().getTime();
                    if (now - parseInt(cacheTime) < CACHE_DURATION) {
                        const files = JSON.parse(cachedData);
                        renderFileList(files);
                        updateLastUpdate(new Date(parseInt(cacheTime)));
                        return;
                    }
                }
                
                // 调用GitHub API
                const response = await fetch(GITHUB_API_URL);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }
                
                const files = await response.json();
                const fileItems = files.filter(item => item.type === 'file');
                
                // 保存缓存
                localStorage.setItem('githubFileData', JSON.stringify(fileItems));
                localStorage.setItem('githubFileCacheTime', new Date().getTime().toString());
                
                renderFileList(fileItems);
                updateLastUpdate(new Date());
                
            } catch (error) {
                console.error('获取文件列表失败:', error);
                showError();
            }
        }

        // 渲染文件列表
        function renderFileList(files) {
            loadingEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            fileListEl.classList.remove('hidden');
            
            fileCountEl.textContent = files.length;
            fileListEl.innerHTML = '';
            
            if (files.length === 0) {
                fileListEl.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-white rounded-lg">
                        <i class="fa fa-folder-open-o text-4xl text-gray-300 mb-3"></i>
                        <p>仓库中没有可下载的文件</p>
                    </div>
                `;
                return;
            }
            
            files.forEach(file => {
                const fileExt = getFileExtension(file.name);
                const fileIcon = getFileIcon(fileExt);
                
                // 构建两种下载链接 (主链接和备用链接)
                const primaryDownloadUrl = file.download_url;
                const secondaryDownloadUrl = `${RAW_GITHUB_URL}/${encodeURIComponent(file.name)}`;
                
                const fileCard = document.createElement('div');
                fileCard.className = 'file-card';
                fileCard.innerHTML = `
                    <div class="flex items-start">
                        <i class="fa ${fileIcon} text-primary text-xl mt-1 mr-3"></i>
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-800 truncate" title="${file.name}">${file.name}</h3>
                            <p class="text-gray-500 text-sm mt-1">
                                ${formatFileSize(file.size)}
                            </p>
                            <div class="mt-3 flex gap-2">
                                <button class="download-btn btn-download" 
                                        data-primary="${primaryDownloadUrl}"
                                        data-secondary="${secondaryDownloadUrl}">
                                    <i class="fa fa-download mr-1"></i> 下载
                                </button>
                                <button class="download-btn btn-retry" style="display:none"
                                        data-primary="${primaryDownloadUrl}"
                                        data-secondary="${secondaryDownloadUrl}">
                                    <i class="fa fa-refresh mr-1"></i> 尝试备用链接
                                </button>
                            </div>
                            <span class="download-status hidden" id="status-${file.sha}"></span>
                        </div>
                    </div>
                `;
                
                fileListEl.appendChild(fileCard);
            });
            
            // 为所有下载按钮添加事件监听
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', handleDownload);
            });
        }

        // 处理下载逻辑
        async function handleDownload(e) {
            const btn = e.currentTarget;
            const primaryUrl = btn.getAttribute('data-primary');
            const secondaryUrl = btn.getAttribute('data-secondary');
            const statusEl = btn.parentElement.nextElementSibling;
            
            // 显示加载状态
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 准备中...';
            statusEl.textContent = '正在验证下载链接...';
            statusEl.classList.remove('hidden', 'text-green-600', 'text-danger');
            statusEl.classList.add('text-primary');
            
            try {
                // 先尝试主链接
                const response = await fetch(primaryUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    // 主链接有效，直接下载
                    statusEl.textContent = '开始下载...';
                    statusEl.classList.add('text-green-600');
                    window.open(primaryUrl, '_blank');
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa fa-download mr-1"></i> 下载';
                    }, 1000);
                } else {
                    // 主链接无效，尝试备用链接
                    statusEl.textContent = '主链接无效，尝试备用链接...';
                    
                    const secondaryResponse = await fetch(secondaryUrl, { method: 'HEAD' });
                    if (secondaryResponse.ok) {
                        statusEl.textContent = '开始下载...';
                        statusEl.classList.add('text-green-600');
                        window.open(secondaryUrl, '_blank');
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fa fa-download mr-1"></i> 下载';
                        }, 1000);
                    } else {
                        throw new Error('所有链接均无效');
                    }
                }
            } catch (error) {
                console.error('下载链接验证失败:', error);
                statusEl.textContent = '下载链接无效';
                statusEl.classList.add('text-danger');
                
                // 显示备用链接按钮
                btn.style.display = 'none';
                const retryBtn = btn.parentElement.querySelector('.btn-retry');
                retryBtn.style.display = 'inline-flex';
                retryBtn.disabled = false;
            }
        }

        // 显示加载状态
        function showLoading() {
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            fileListEl.classList.add('hidden');
        }

        // 显示错误状态
        function showError() {
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            fileListEl.classList.add('hidden');
        }

        // 更新最后更新时间
        function updateLastUpdate(date) {
            lastUpdateEl.textContent = date.toLocaleString();
        }

        // 获取文件扩展名
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        // 获取文件图标
        function getFileIcon(ext) {
            const icons = {
                'zip': 'fa-file-archive-o',
                'rar': 'fa-file-archive-o',
                '7z': 'fa-file-archive-o',
                'gz': 'fa-file-archive-o',
                'tar': 'fa-file-archive-o',
                'exe': 'fa-file-exe-o',
                'pdf': 'fa-file-pdf-o',
                'doc': 'fa-file-word-o',
                'docx': 'fa-file-word-o',
                'xls': 'fa-file-excel-o',
                'xlsx': 'fa-file-excel-o',
                'jpg': 'fa-file-image-o',
                'png': 'fa-file-image-o',
                'gif': 'fa-file-image-o',
                'mp3': 'fa-file-audio-o',
                'mp4': 'fa-file-video-o',
                'txt': 'fa-file-text-o',
                'html': 'fa-file-code-o',
                'js': 'fa-file-code-o'
            };
            
            return icons[ext] || 'fa-file-o';
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1048576) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / 1048576).toFixed(1)} MB`;
        }
    </script>
</body>
</html>
    
